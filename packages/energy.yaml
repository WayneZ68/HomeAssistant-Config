################################################################
## Packages / Energy usage and measurements.
################################################################
## 30-may-17 - Added Smart Meter info

################################################
## Customize
################################################

homeassistant:
  customize:
    packages.energy: &customize
      package: 'energy'

    packages.energy_exposed: &customize_exposed
      <<: *customize

    packages.energy_contained: &customize_contained
      <<: *customize

    automation.notify_meter_readings_at_midnight:
      <<: *customize
      friendly_name: "Meterstanden notificatie"
      icon: mdi:comment-alert-outline

    group.total_energy_consumption:
      <<: *customize_contained
      friendly_name: "Energie verbruik"
      icon: mdi:gauge

    sensor.gas_consumption:
      <<: *customize_contained
      friendly_name: "Meterstand Gas"

    sensor.hourly_gas_consumption:
      <<: *customize_contained
      friendly_name: "Gasverbruik per uur"

    sensor.power_consumption:
      <<: *customize_contained
      friendly_name: "Electriciteit verbruik"

    sensor.power_consumption_low:
      <<: *customize_contained
      friendly_name: "Meterstand daltarief"

    sensor.power_consumption_normaal:
      <<: *customize_contained
      friendly_name: "Meterstand normaal tarief"

    sensor.energytariff_nl:
      <<: *customize_contained
      friendly_name: "Actief tarief"
      icon: mdi:currency-eur

    sensor.achterdeur_schakelaars_energy_4_0:
      <<: *customize_contained
      friendly_name: "Bijkeuken lamp"
      icon: mdi:lightbulb

    sensor.achterdeur_schakelaars_energy_4_0_2:
      <<: *customize_contained
      friendly_name: "Buitenlamp achterdeur"
      icon: mdi:lightbulb

    group.current_power_consumption:
      <<: *customize_contained
      friendly_name: "Huidig verbruik"
      icon: mdi:flash

    sensor.achterdeur_schakelaars_power_4_8:
      <<: *customize_contained
      friendly_name: "Bijkeuken lamp"
      icon: mdi:lightbulb

    sensor.achterdeur_schakelaars_power_4_8_2:
      <<: *customize_contained
      friendly_name: "Buitenlamp achterdeur"
      icon: mdi:lightbulb

    sensor.vaatwasser_power_6_8:    # Dishwasher: Watts
      <<: *customize_contained
      friendly_name: "Vaatwasser"
      icon: mdi:power-plug

    sensor.vaatwasser_voltage_6_16: # Dishwasher: Volts
      <<: *customize_contained
      friendly_name: "Vaatwasser spanning"
      icon: mdi:power-socket-eu

    sensor.vaatwasser_current_6_20: # Dishwasher: Amps
      <<: *customize_contained
      friendly_name: "Vaatwasser stroom"
      icon: mdi:power-plug


################################################
## Automation
################################################

automation:

  ################################################
  ## Notification at midnight with readings from the smart meter
  ################################################
  - alias: notify_meter_readings_at_midnight
    initial_state: 'on'
    trigger:
      - platform: time
        after: '23:59:00'
    action:
      service: notify.pushover
      data_template:
        title: "Meterstanden"
        message: "Hoog: {{ states.sensor.power_consumption_normal.state }}, Laag: {{ states.sensor.power_consumption_low.state }}, Gas: {{ states.sensor.gas_consumption.state }}. Min-temp: {{ states.sensor.dark_sky_daily_low_temperature.state }}, Max-temp: {{ states.sensor.dark_sky_daily_high_temperature.state }}"


################################################
## Group
################################################
group:
  total_energy_consumption:
    control: hidden
    entities:
      - sensor.gas_consumption
      - sensor.power_consumption_low
      - sensor.power_consumption_normal
      - sensor.energytariff_nl
      - sensor.vaatwasser_energy_6_0   # Dishwasher kWh
      - sensor.achterdeur_schakelaars_energy_4_0       # Scullery light
      - sensor.achterdeur_schakelaars_energy_4_0_2     # Backdoor outside light

  current_power_consumption:
    control: hidden
    entities:
      - sensor.hourly_gas_consumption
      - sensor.power_consumption
      - sensor.vaatwasser_power_6_8    # Dishwasher: Watts
      - sensor.vaatwasser_current_6_20 # Dishwasher: Amps
      - sensor.vaatwasser_voltage_6_16 # Dishwasher: Volts
      - sensor.achterdeur_schakelaars_power_4_8        # Scullery light
      - sensor.achterdeur_schakelaars_power_4_8_2      # Backdoor outside light

################################################
## Sensor
################################################

sensor:
  - platform: dsmr
    port: /dev/slimmemeter
    dsmr_version: 4
  - platform: template
    sensors:
      energytariff_nl:
        friendly_name: 'Tarief'
        value_template: >-
            {%- if is_state("sensor.power_tariff", "low") %}
                Dal (€ 0,1669/kWh)
            {% elif is_state("sensor.power_tariff", "normal") %}
                Normaal (€ 0,1781/kWh)
            {%- endif %}
